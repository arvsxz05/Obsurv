{% extends "base.html" %}

{% block styles %}
    <style type="text/css">
    	.card-content[disabled] {
    		opacity: 0.5;
    		pointer-events: none;
    		cursor: default;
    	}
        .error {
            color: red;
            font-size: 15px;
        }
    </style>
{% endblock %}

{% block content %}
	<div class="row container">
		<form action = "{% url 'index' %}" method="POST">
			{% csrf_token %}
			<div class="card">
				<div class="card-content container">
					<span class="card-title">Create Poll</span>
					<div class="input-field">
			            <textarea id="textarea1" name="question" class="materialize-textarea" data-length="200">{{ question }}</textarea>
			            <label for="textarea1">Write Question</label>
		          	</div>
		          	<input type="hidden" id="no_of_choices" name="no_of_choices" value="0">
		        	<ul id="choices_space">
		        		<li>
		        			<div class="input-field">
			        			<i class="material-icons prefix">input</i>
			        			<input placeholder="Enter a Choice" id="id0" name="id0" type="text" oninput="blurFunction()" onblur="blurFunction()">
			        		</div>
			        	</li>
		        	</ul>
		        	<div class="row">
			        	<div class="input-field col s12 m6">
		   					<input id="end-date" class="datepicker" name="end_date" type="date" required>
		   					<label for="end-date">End Date</label>
		   				</div>
		   				<div class="input-field col s12 m6">
	                        <label for="end_time">End Time</label>
	                        <input id="end_time" class="timepicker" name="end_time" type="time" required>
                    	</div>
	   				</div>
		        	<p>
						<input type="checkbox" class="filled-in" id="filled-in-box" name="multiple"/>
						<label for="filled-in-box">Multiple Answer</label>
	   				</p>
	   				
	   				 <span class="red-text">{{ error }}</span>
			    </div>
			    <div class="card-action">
					<button class="waves-effect waves-light btn"><i class="material-icons left">assessment</i>Create Poll</button>
				</div>
			</div>
		</form>
	</div>
	<div class="container">
	{% for temp_question1, temp_question2 in questions %}
        <div class="row">
			<div class="col s12 m6">
				<div class="card blue-grey darken-1" disabled>
					<form class="response-form" method="POST" action="{% url 'respond' temp_question1.id %}">
						{% csrf_token %}
						<div class="card-content white-text" id="card-{{ temp_question1.id }}">
							<span class="card-title">
								<div class="row valign-wrapper">
									<div class="col s2">
							        	<img src="{{ temp_question1.user_owner.profile.avatar_url }}" alt="" class="circle responsive-img"> <!-- notice the "circle" class -->
							        </div>
							        <div class="col s10">
										{{ temp_question1.user_owner.username }}
										<h6 class="grey-text text-lighten-2">{{ temp_question1.when_created }}</h6>
									</div>
								</div>
							</span>
							<p>{{ temp_question1.question_text }}</p>
							{% for single_choice in temp_question1.Choices.all %}
								<p>
									{% if not temp_question1.multiple_answer %}
										<input type="radio" class="with-gap" id="{{ single_choice.id }}" value="{{ single_choice.id }}" name="response"/>
									{% else %}
										<input type="checkbox" class="filled-in" id="{{ single_choice.id }}" value="{{ single_choice.id }}" name="response"/>
									{% endif %}
									<label for="{{ single_choice.id }}">{{ single_choice.choice_text }}</label>
							    </p>
							{% endfor %}
							<p class="error" id="response-error-{{ temp_question1.id }}" type="hidden"></p>
						</div>
						<div class="card-action">
							<div class="row">
								<button class="waves-effect waves-light btn col l5 m4 s12 hoverable"><i class="material-icons left">assessment</i>Respond</button>
								<button class="waves-effect waves-light btn col l4 m4 s12 hoverable" type="button"><i class="material-icons left">visibility</i>View</button>
								<div class="white-text col l3 m4 s12"><i class="material-icons left">supervisor_account</i><h6 id="number-{{ temp_question1.id }}">{{ temp_question1.respondent_count }}</h6></div>
							</div>
						</div>
					</form>
				</div>
			</div>
			{% if temp_question2 %}
			<div class="col s12 m6">
				<div class="card blue-grey darken-1">
					<form class="response-form" method="POST" action="{% url 'respond' temp_question2.id %}">
						{% csrf_token %}
						<div class="card-content white-text" id="card-{{ temp_question2.id }}">
							<span class="card-title">
								<div class="row valign-wrapper">
									<div class="col s2">
							        	<img src="{{ temp_question2.user_owner.profile.avatar_url }}" alt="" class="circle responsive-img"> <!-- notice the "circle" class -->
							        </div>
							        <div class="col s10">
										{{ temp_question2.user_owner.username }}
										<h6 class="grey-text text-lighten-2">{{ temp_question2.when_created }}</h6>
									</div>
								</div>
							</span>
							<p>{{ temp_question2.question_text }}</p>
							{% for single_choice in temp_question2.Choices.all %}
								<p>
									{% if not temp_question2.multiple_answer %}
										<input type="radio" class="with-gap" id="{{ single_choice.id }}" value="{{ single_choice.id }}" name="response"/>
									{% else %}
										<input type="checkbox" class="filled-in" id="{{ single_choice.id }}" value="{{ single_choice.id }}" name="response"/>
									{% endif %}
									<label for="{{ single_choice.id }}">{{ single_choice.choice_text }}</label>
							    </p>
							{% endfor %}
							<p class="error" id="response-error-{{ temp_question2.id }}" type="hidden"></p>
						</div>
						<div class="card-action">
							<div class="row">
								<button class="waves-effect waves-light btn col l5 m4 s12 hoverable"><i class="material-icons left">assessment</i>Respond</button>
								<button class="waves-effect waves-light btn col l4 m4 s12 hoverable" type="button"><i class="material-icons left">visibility</i>View</button>
								<div class="white-text col l3 m4 s12"><i class="material-icons left">supervisor_account</i><h6 id="number-{{ temp_question2.id }}">{{ temp_question2.respondent_count }}</h6></div>
							</div>
						</div>
					</form>
				</div>
			</div>
			{% endif %}
    	</div>
    {% endfor %}
    </div>
{% endblock %}

{% block js %}
	{% load static %}
	<script type="text/javascript" src="{% static 'js/home.js' %}"></script>
	<script type="text/javascript">
		$(function(ready){
		    $(".response-form").submit(function (event) {
		    	event.preventDefault();
		        // var response = $(this).find('input[name=response]').val();
		        var allVals = [];
				$(this).find('input[name=response]:checked').each(function() {
					allVals.push($(this).val());
				});
			    console.log(allVals);
			    if(allVals.length == 0) {
			    	$(this).find(".error").show();
		            $(this).find(".error").text('Choose an answer to respond!');
		            // console.log($(this).children(".error").val());
		        } else {
		            $("#response-error").hide();

			        $.ajax({
			            url: $(this).attr('action'),
			            data: {
			                'response': allVals
			            },
			            dataType: 'json',
			            success: function (data) {
			            	suffix = data.question;
			                if (!data.success) {
			                    $("#response-error-"+suffix).show();
			                    $("#response-error-"+suffix).text('Something went wrong...');
			                } else {
			                	console.log(data.no_respondents);
			                    $("#response-error-"+suffix).show();
			                    $("#response-error-"+suffix).text('Your response has been recorded.');
			                    $("#card-"+suffix).attr("disabled", true);
			                    $("#number-"+suffix).text(data.no_respondents);
			                }
			            }
			        });
			    }
		    });
		});
	</script>
{% endblock %}